{% extends 'list.html' %}
{% load static %}
{% load i18n %}
{% load psat_filter %}

{% block main %}
    {% include 'snippets/page_title.html' %}

    <section class="section">
        <div class="row">
            <article class="col-xxl-8">
                <problem id="containerProblem" class="card htmx-fade-in htmx-fade-out">
                    <div class="card-body">
                        <div class="card-title mb-0 row">
                            <div class="d-flex align-items-center fs-6">
                                <div class="d-flex align-items-center">
                                    {% include 'a_psat/snippets/navigation_container.html' %}
                                </div>
                            </div>
                            <div class="d-flex align-items-center fs-6">
                                <div class="text-nowrap me-auto">
                                    {% include 'a_psat/snippets/custom_icons.html' %}
                                </div>
                                <div class="ms-auto justify-content-end">
                                    {% include 'a_psat/snippets/problem_detail_solve_container.html' %}
                                </div>
                            </div>
                        </div>

                        <div id="problemDetail" class="htmx-fade-in htmx-fade-out">
                            {% if not problem.has_img %}
                                <div class="border-top pt-2">
                                    <div class="d-flex">
                                        <h6 class="lh-base text-nowrap me-2 fw-bold text-primary">
                                            문&nbsp;{{ problem.number|add_space }}.
                                        </h6>
                                        <h6 class="lh-base fw-bold text-secondary">
                                            {{ problem.question }}
                                        </h6>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="d-lg-none">
                                {% with annotate_type='normal' problem_img=problem.img_normal %}
                                    {% partial container_image %}
                                {% endwith %}
                            </div>

                            <div class="d-none d-lg-block">
                                {% with annotate_type='wide' problem_img=problem.img_wide %}
                                    {% partial container_image %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </problem>
            </article>

            <div class="col-xxl-4">
                <div class="row">
                    <div class="col-md-6 col-xxl-12">{% partial container_memo %}</div>
                    <div class="col-md-6 col-xxl-12">{% partial container_tag %}</div>
                </div>
            </div>
        </div>
{#        <div class="row">#}
{#            <div class="col-12">{% partial container_comment %}</div>#}
{#        </div>#}
    </section>

    <div id="modalContainerPsat" class="modal fade htmx-fade-in htmx-fade-out" style="display: none"
         aria-hidden="true" tabindex="-1" aria-labelledby="modalContainerLabel">
        {% partial modal_image %}
    </div><!-- Modal Container: Problem Image -->
{% endblock main %}

{% partialdef container_image %}
    {% if problem_img.alt == 'Preparing Image' %}
        <img class="d-block mx-auto" alt="{{ problem_img.alt }}" src="{{ problem_img.src }}">
    {% else %}
        {% if user.is_superuser %}
            <div id="{{ annotate_type }}BtnContainer"
                 class="d-flex align-items-center justify-content-center justify-content-md-between flex-wrap gap-3">
                <div class="d-flex gap-1 align-items-center justify-content-center" role="group"
                     aria-label="필기 버튼 그룹">
                    <div class="{{ annotate_type }}-drawing-btn-container" data-annotate-container="drawing">
                        <label class="switch">
                          <input type="checkbox" id="{{ annotate_type }}DrawingBtn">
                          <span class="slider slider-drawing"></span>
                        </label>
                        <span id="{{ annotate_type }}DrawingStatus" class="fw-bold drawing-btn me-2">
                            필기
                        </span>
                    </div>

                    <div class="{{ annotate_type }}-tool-btn-group d-flex text-nowrap gap-1"
                         data-annotate-container="style">
                        <button class="tool-btn" data-annotate-style="pen">
                            <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor"
                                      d="M290.74 93.24l128.02 128.02-277.99 277.99-114.14 12.6C11.35 513.54-1.56 500.62.14 485.34l12.7-114.22 277.9-277.88zm207.2-19.06l-60.11-60.11c-18.75-18.75-49.16-18.75-67.91 0l-56.55 56.55 128.02 128.02 56.55-56.55c18.75-18.76 18.75-49.16 0-67.91z"></path>
                            </svg>
                        </button>
                        <button class="tool-btn" data-annotate-style="highlighter">
                            <svg viewBox="0 -16 544 544" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor"
                                      d="M0 479.98L99.92 512l35.45-35.45-67.04-67.04L0 479.98zm124.61-240.01a36.592 36.592 0 0 0-10.79 38.1l13.05 42.83-50.93 50.94 96.23 96.23 50.86-50.86 42.74 13.08c13.73 4.2 28.65-.01 38.15-10.78l35.55-41.64-173.34-173.34-41.52 35.44zm403.31-160.7l-63.2-63.2c-20.49-20.49-53.38-21.52-75.12-2.35L190.55 183.68l169.77 169.78L530.27 154.4c19.18-21.74 18.15-54.63-2.35-75.13z"></path>
                            </svg>
                        </button>
                        <button class="tool-btn" data-annotate-style="eraser">
                            <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor"
                                      d="M497.941 273.941c18.745-18.745 18.745-49.137 0-67.882l-160-160c-18.745-18.745-49.136-18.746-67.883 0l-256 256c-18.745 18.745-18.745 49.137 0 67.882l96 96A48.004 48.004 0 0 0 144 480h356c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12H355.883l142.058-142.059zm-302.627-62.627l137.373 137.373L265.373 416H150.628l-80-80 124.686-124.686z"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="{{ annotate_type }}-tool-btn-group d-flex text-nowrap gap-1"
                         data-annotate-container="shape">
                        <button class="tool-btn" data-annotate-shape="curve">
                            <svg viewBox="0 0 189.929 189.929" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor"
                                      d="M70.343,70.343c-30.554,30.553-44.806,72.7-39.102,115.635l-29.738,3.951C-5.442,137.659,11.917,86.34,49.129,49.13 C86.34,11.918,137.664-5.445,189.928,1.502l-3.95,29.738C143.041,25.54,100.895,39.789,70.343,70.343z"></path>
                            </svg>
                        </button>
                        <button class="tool-btn" data-annotate-shape="line">
                            <svg viewBox="0 0 171.213 171.213" xmlns="http://www.w3.org/2000/svg">
                                <path fill="currentColor" d="M171.213,21.213l-150,150L0,150L150,0L171.213,21.213z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="d-flex gap-1 align-items-center justify-content-center" role="group"
                     aria-label="색상 및 액션 버튼 그룹">
                    <div class="{{ annotate_type }}-color-btn-group d-flex text-nowrap gap-1" role="group"
                         data-annotate-container="color">
                        <button class="color-btn" data-annotate-color="black"></button>
                        <button class="color-btn" data-annotate-color="red"></button>
                        <button class="color-btn" data-annotate-color="blue"></button>
                        <button class="color-btn" data-annotate-color="green"></button>
                        <button class="color-btn" data-annotate-color="yellow"></button>
                    </div>

                    <div class="{{ annotate_type }}-action-btn-group d-flex text-nowrap gap-1" role="group"
                         data-annotate-container="action">
                        <button class="action-btn" data-annotate-action="undo" disabled>
                            <svg fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                <path d="M250.6,66.8V0L136.7,111.3l113.9,111.3v-66.8c73.7,0,133.6,59.8,133.6,133.6c0,73.8-59.8,133.6-133.6,133.6 C176.9,423,117,363.2,117,289.4H28C28,412.3,127.7,512,250.6,512c123,0,222.6-99.7,222.6-222.6C473.2,166.4,373.6,66.8,250.6,66.8z"></path>
                            </svg>
                        </button>
                        <button class="action-btn" data-annotate-action="redo" disabled>
                            <svg fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                <path d="M389.6,289.4c0,73.8-59.8,133.6-133.6,133.6c-73.7,0-133.6-59.8-133.6-133.6c0-73.8,59.8-133.6,133.6-133.6v66.8 l113.9-111.3L256,0v66.8c-122.9,0-222.6,99.7-222.6,222.6C33.4,412.3,133.1,512,256,512c122.9,0,222.6-99.7,222.6-222.6H389.6z"></path>
                            </svg>
                        </button>
                        <button class="action-btn" data-annotate-action="load">
                            <svg fill="#currentColor" fill-rule="evenodd" viewBox="0 -2 30 30"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path transform="translate(-103.000000, -728.000000)"
                                      d="M132,728 L104,728 C103.521,728 103,728.521 103,729 L103,736 C103,737.104 103.896,738 105,738 C106.104,738 107,737.104 107,736 L107,732 L129,732 L129,736 C129,737.104 129.896,738 131,738 C132.104,738 133,737.104 133,736 L133,729 C133,728.458 132.604,728 132,728 L132,728 Z M122,746 L120,746 L120,737 C120,735.896 119.104,735 118,735 C116.896,735 116,735.896 116,737 L116,746 L114,746 C113.608,746 112.705,745.905 112.313,746.3 C111.921,746.693 111.921,747.332 112.313,747.726 L117.255,753.717 C117.464,753.927 117.742,754.017 118.016,754.002 C118.29,754.017 118.567,753.927 118.776,753.717 L123.718,747.726 C124.11,747.332 124.11,746.693 123.718,746.3 C123.326,745.905 122.705,746 122,746 L122,746 Z"></path>
                            </svg>
                        </button>
                        <button class="action-btn" data-annotate-action="save">
                            <svg fill="#currentColor" fill-rule="evenodd" viewBox="0 -2 30 30"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path transform="translate(-571.000000, -676.000000)"
                                      d="M599,692 C597.896,692 597,692.896 597,694 L597,698 L575,698 L575,694 C575,692.896 574.104,692 573,692 C571.896,692 571,692.896 571,694 L571,701 C571,701.479 571.521,702 572,702 L600,702 C600.604,702 601,701.542 601,701 L601,694 C601,692.896 600.104,692 599,692 L599,692 Z M582,684 L584,684 L584,693 C584,694.104 584.896,695 586,695 C587.104,695 588,694.104 588,693 L588,684 L590,684 C590.704,684 591.326,684.095 591.719,683.7 C592.11,683.307 592.11,682.668 591.719,682.274 L586.776,676.283 C586.566,676.073 586.289,675.983 586.016,675.998 C585.742,675.983 585.465,676.073 585.256,676.283 L580.313,682.274 C579.921,682.668 579.921,683.307 580.313,683.7 C580.705,684.095 581.608,684 582,684 L582,684 Z"></path>
                            </svg>
                        </button>
                        <button class="action-btn" data-annotate-action="clear">
                            <svg fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"
                                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.5 3L15.5 4H19V6H5V4H8.5L9.5 3H14.5ZM8 21C6.9 21 6 20.1 6 19V7H18V19C18 20.1 17.1 21 16 21H8ZM12 12.59L14.12 10.47L15.53 11.88L13.41 14L15.53 16.12L14.12 17.53L12 15.41L9.88 17.53L8.47 16.12L10.59 14L8.46 11.88L9.87 10.47L12 12.59Z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="position-relative">
            <img id="{{ annotate_type }}Image" class="img-fluid" alt="{{ problem_img.alt }}" src="{{ problem_img.src }}">
            <canvas id="{{ annotate_type }}Canvas" class="position-absolute top-0 start-0"
                    style="z-index: 10; touch-action: none;"
                    data-annotate-url="{{ problem.get_annotate_url }}"></canvas>
        </div>
    {% endif %}
{% endpartialdef %}

{% partialdef container_memo %}
    <div id="containerMemo" class="card htmx-fade-in htmx-fade-out">
        <div class="card-body">
            <div id="accordionMemo" class="accordion accordion-flush">
                <div class="accordion-item">
                    <h2 id="headingMemo" class="accordion-header">
                        <button class="accordion-button" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseMemo"
                                aria-expanded="true" aria-controls="collapseMemo">
                            <span class="badge bg-warning me-2">{{ icon_memo.white|safe }} 메모</span>
                            <div class="small text-warning fw-bold">
                                나만 볼 수 있는 메모를 남겨보세요.
                            </div>
                        </button>
                    </h2>
                    <hr class="border-secondary mt-0">
                    <div id="collapseMemo" class="accordion-collapse collapse show"
                         aria-labelledby="headingMemo" data-bs-parent="#accordionMemo">
                        <div id="collapseMemoContent" class="htmx-fade-in htmx-fade-out"
                             hx-target="#collapseMemoContent" hx-swap="innerHTML swap:0.25s">
                            {% if user.is_authenticated %}
                                {% include 'a_psat/snippets/memo_container.html' %}
                            {% else %}
                                {% partial need_login %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endpartialdef %}

{% partialdef container_tag %}
    <div id="containerTag" class="card htmx-fade-in htmx-fade-out">
        <div class="card-body">
            <div id="accordionTag" class="accordion accordion-flush">
                <div class="accordion-item">
                    <h2 id="headingTag" class="accordion-header">
                        <button class="accordion-button" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseTag"
                                aria-expanded="true" aria-controls="collapseTag">
                            <span class="badge bg-primary me-2">{{ icon_tag.white|safe }} 태그</span>
                            <div class="small text-primary fw-bold">
                                나만 볼 수 있는 태그를 남겨보세요.
                            </div>
                        </button>
                    </h2>
                    <hr class="border-secondary mt-0">
                    <div id="collapseTag" class="accordion-collapse collapse show"
                         aria-labelledby="headingTag" data-bs-parent="#accordionTag">
                        <div id="collapseTagContent" class="htmx-fade-in htmx-fade-out"
                             hx-target="#collapseTagContent" hx-swap="innerHTML swap:0.25s">
                            {% if user.is_authenticated %}
                                <div class="tw-text-sm tw-mb-2 tw-px-2">
                                    <input id="problemTag{{ problem.id }}"
                                           placeholder='태그를 입력해주세요' type="hidden"
                                           data-tag-target="#psatTag{{ problem.id }}"
                                           data-tagify data-action="{{ problem.get_tag_url }}"
                                           data-tags="{{ tags|join:',' }}">
                                </div>
                            {% else %}
                                {% partial need_login %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endpartialdef %}

{% partialdef container_comment %}
    <div id="containerComment" class="card htmx-fade-in htmx-fade-out">
        <div class="card-body">
            <div id="accordionComment" class="accordion accordion-flush">
                <div class="accordion-item">
                    <h2 id="headingComment" class="accordion-header">
                        <button class="accordion-button" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseComment"
                                aria-expanded="true" aria-controls="collapseComment">
                            <span class="badge bg-success me-2">{{ icon_question.white|safe }} 질문</span>
                            <div class="small text-success fw-bold">
                                문제에 관한 질문이나 댓글을 남겨보세요.
                            </div>
                        </button>
                    </h2>
                    <div class="d-flex justify-content-end mb-3">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" title="{% trans 'Reload' %}"
                                    hx-target="#collapseCommentContent" hx-swap="innerHTL swap:0.25s"
                                    hx-get="">
{#                                    hx-get="{% url 'psat:comment_container' problem.id %}">#}
                                <i class="fa-solid fa-rotate-right"></i> 새로고침
                            </button>
                            <button class="btn btn-sm btn-outline-success" title="{% trans 'Comment' %}"
                                    hx-target="#modalContainer" data-bs-toggle="modal" data-bs-target="#modalContainer"
                                    hx-get="">
{#                                    hx-get="{% url 'psat:comment_create' problem.id %}">#}
                                {{ icon_question.filter|safe }} 질문하기
                            </button>
                    {#        <button class="btn btn-sm btn-outline-success"#}
                    {#                hx-get="{% url 'psat:comment_container' problem_id %}">#}
                    {#            <i class="fa-regular fa-window-maximize"></i>#}
                    {#            새 창#}
                    {#        </button>#}
                        </div>
                    </div>
                    <hr class="border-secondary"/>
                    <div id="collapseComment" class="accordion-collapse collapse show"
                         aria-labelledby="headingComment" data-bs-parent="#accordionComment">
                        <div id="collapseCommentContent" class="htmx-fade-in htmx-fade-out"
                             hx-target="#collapseCommentContent" hx-swap="innerHTML swap:0.25s">
                            {% if user.is_authenticated %}
{#                                <div hx-trigger="load" hx-get="{% url 'psat:comment_container' problem.id %}"></div>#}
                            {% else %}
                                {% partial need_login %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endpartialdef %}

{% partialdef modal_image %}
    {% #modal header=problem.full_reference size="modal-xl" %}
        {% partialdef problem_image inline %}
            <div class="d-flex d-lg-none justify-content-center">
                <img class="mw-100" alt="{{ problem.img_normal.alt }}" src="{{ problem.img_normal.src }}"/>
            </div>
            <div class="d-none d-lg-flex justify-content-center">
                <img class="mw-100" alt="{{ problem.img_wide.alt }}" src="{{ problem.img_wide.src }}"/>
            </div>
        {% endpartialdef problem_image %}
    {% /modal %}
{% endpartialdef %}

{% partialdef need_login %}
    <ul class="list-group">
        <li class="list-group-item">
            <a class="text-secondary" hx-target="body"
               href="{% url 'account_login' %}" hx-boost="true"
               hx-swap="innerHTML swap:0.25s" hx-trigger="click">
                {% trans 'Please login first.' %}
            </a>
        </li>
    </ul>
{% endpartialdef %}


{% block page_script %}
    <script type="module" src="{% static 'a_psat/annotation/js/src/main.js' %}"></script>
{% endblock page_script %}
