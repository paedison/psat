{% extends 'list.html' %}
{% load static %}
{% load i18n %}
{% load psat_filter %}
{% load partials %}

{% block main %}
{% partialdef comment_main inline=True %}
<div class="card-body" hx-target="#containerComment">
    <div id="accordionComment" class="accordion accordion-flush">
        <div class="accordion-item">
            <h2 id="headingComment" class="accordion-header">
                <button class="accordion-button" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseComment"
                        aria-expanded="true" aria-controls="collapseComment">
                    <span class="badge bg-success">{{ icon_question.white|safe }} 질문</span>
                </button>
            </h2>
            <div id="collapseComment" class="accordion-collapse collapse show"
                 aria-labelledby="headingComment" data-bs-parent="#accordionComment">
                <div class="d-flex justify-content-end">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success"
                                hx-get="{% url 'psat:comment_container' problem_id %}">
                            <i class="fa-solid fa-rotate-right"></i>
                            새로고침
                        </button>
                        <button class="btn btn-sm btn-outline-success"
                                hx-get="{% url 'psat:comment_container' problem_id %}">
                            <i class="fa-regular fa-window-maximize"></i>
                            새 창
                        </button>
                    </div>
                </div>
                {% if comments %}
                    {% for comment in page_obj %}
                        {% partial comment_line %}
                        {% if not comment.reply_comments.exists %}
                            <hr class="border-secondary">
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% partialdef create inline=True %}
                    <div class="htmx-fade-in htmx-fade-out text-gray-900">
                        <form hx-post="{% url 'psat:comment_create' problem_id %}"
                              hx-include="">
                            <input name="parent" type="text" value="{{ parent_id }}"
                                   aria-label="Parent" hidden/>
                            {{ form.media }}
                            {{ form.comment }}
                            {{ form.errors }}
                            <div class="d-flex justify-content-end mt-2">
                                <div class="btn-group">
                                    <textarea name="comment" id="content_comment" hidden></textarea>
                                    <button type="submit" class="btn btn-sm btn-outline-primary ckeditor-submit">
                                        {% trans 'Create' %}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                {% endpartialdef create %}
            </div>
        </div>
    </div>
</div>
{% endpartialdef comment_main %}
{% endblock main %}

{% partialdef comment_line %}
    <div class="row">
        <div class="d-flex{% if comment.parent %} ps-4{% endif %}">
            <div class="me-auto">
                <span class="fw-bold">
                    {{ comment.user.username }}
                </span>
                <span class="small text-secondary">
                    {{ comment.timestamp|date:'m/d' }}
                </span>
            </div>
            <div class="btn-group" role="group" aria-label="Comment buttons">
                {% if not comment.parent %}
                    {% if user.is_authenticated %}
                        <button class="btn btn-sm btn-outline-primary"
                                hx-get="{% url 'psat:comment_create' problem_id %}?parent_id={{ comment.id }}"
                                title="{% trans 'Reply' %}"
                                hx-target="#commentReply{{ comment.id }}">
                            {{ icon_board.reply|safe }}
                        </button>
                    {% else %}
                        <button class="btn btn-sm btn-outline-primary"
                                hx-get="{% url 'account_login_modal' %}"
                                hx-target="#modalContainer"
                                data-bs-toggle="modal" data-bs-target="#modalContainer">
                            {{ icon_board.reply|safe }}
                        </button>
                    {% endif %}
                {% endif %}

                {% if comment.user == user %}
                    <button class="btn btn-sm btn-outline-success"
                            hx-get="{% url 'psat:comment_update' comment.id %}"
                            title="{% trans 'Update' %}"
                            hx-target="#commentContent{{ comment.id }}">
                        {{ icon_board.update|safe }}
                    </button>
                    <button class="btn btn-sm btn-outline-danger"
                            hx-post="{% url 'psat:comment_delete' comment.id %}"
                            title="{% trans 'Delete' %}"
                            hx-confirm="{% trans 'Are you sure you wish to delete your question or comment?' %}">
                        {{ icon_board.delete|safe }}
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="row">
        <div id="commentContent{{ comment.id }}"
             class="htmx-fade-in htmx-fade-out text-gray-900 pt-2{% if comment.parent %} ps-4{% endif %}">
            {{ comment.comment|safe }}
        </div>
        <div id="commentReply{{ comment.id }}"
             class="htmx-fade-in htmx-fade-out text-gray-900 pt-2 ps-4">
        </div>
    </div>
{% endpartialdef comment_line %}

{% partialdef update %}
<form hx-post="{% url 'psat:comment_update' comment.id %}" hx-target="#containerComment">
    <input name="parent_id" type="text" value="{{ comment.parent_id }}"
           aria-label="User" hidden/>
        {{ form.media }}
        {{ form.comment }}
    <div class="d-flex justify-content-end mt-2">
        <div class="btn-group">
            <button hx-get="{% url 'psat:comment_container' comment.problem_id %}"
                    class="btn btn-sm btn-outline-primary">
                {% trans 'Cancel' %}
            </button>
            <textarea name="comment" id="content_comment" hidden></textarea>
            <button type="submit" class="btn btn-sm btn-outline-primary ckeditor-submit">
                {% trans 'Update' %}
            </button>
        </div>
    </div>
</form>
{% endpartialdef update %}
