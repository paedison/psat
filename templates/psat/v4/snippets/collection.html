{% load static %}
{% load i18n %}
{% load slippers %}
{% load partials %}
{% load psat_filter %}
{% load crispy_forms_tags %}

<div class="row">
    <div class="accordion col-sm-6 col-lg-4" id="collectionListAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button fw-bold" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collectionListAccordionBody"
                        aria-expanded="true" aria-controls="collectionListAccordionBody">
                    컬렉션 리스트
                </button>
            </h2>
            <div id="collectionListAccordionBody" class="accordion-collapse collapse show"
                 data-bs-parent="#collectionListAccordion">
                <div class="accordion-body p-0">
                    <div id="collectionList">
                        <form id="collectionListForm" class="sortable list-group htmx-fade-out htmx-fade-in"
                              hx-post="{% url 'psat:collection_list_sort' %}" hx-push-url="false"
                              hx-swap="none" hx-trigger="end">
                            {% partial card_list %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-8 mt-3 mt-sm-0 htmx-fade-out htmx-fade-in" hx-target="#main">
        {% partial card_item_title %}
        <hr/>
        <form id="collectionItemForm" class="sortable htmx-fade-out htmx-fade-in"
              hx-post="{% url 'psat:collection_item_sort' %}"
              hx-swap="none" hx-trigger="end">
            {% partial item_contents %}
        </form>
    </div>

    <script>
        htmx.onLoad(function(content) {
            let sortables = content.querySelectorAll(".sortable");
            for (let i = 0; i < sortables.length; i++) {
                let sortable = sortables[i];
                let sortableInstance = new Sortable(sortable, {
                    animation: 150,
                    ghostClass: 'blue-background-class',
                });
            }
        })
    </script>
</div>

{% partialdef reload_card_list %} {# SortListView #}
    <div hx-swap-oob="innerHTML:#collectionListForm">
        {% partialdef card_list inline=True %}
            {% if collections %}
                <div class="list-group-item list-group-item-action p-0"></div>
                {% for collection in collections %}
                    <div id="collectionList{{ collection.id }}" class="list-group-item list-group-item-action p-0">
                        <input type="hidden" name="collection" value="{{ collection.id }}"/>
                        <div class="container">
                            <div class="row">
                                <div class="col-1 col-sm-2 col-md-1 p-0">
                                    <div class="d-flex h-100 align-items-center justify-content-center bg-warning-subtle">
                                        <div class="fw-bold py-2">{{ collection.order }}</div>
                                    </div>
                                </div>
                                <div class="col-9 col-sm-8 col-md-9 px-1">
                                    <div class="d-flex h-100 align-items-center justify-content-start">
                                        <a class="text-black" href="" hx-swap="none"
                                           hx-get="{% url 'psat:collection_item' collection.id %}">
                                            {{ collection.title }}
                                        </a>
                                    </div>
                                </div>
                                <div class="col-2 text-nowrap">
                                    <div class="d-flex h-100 align-items-center justify-content-end">
                                        <a class="me-1 htmx-fade-in htmx-fade-out" href=""
                                           hx-get="{% url 'psat:collection_modal_update' %}?collection={{ collection.id }}"
                                           hx-target="#modalContainer" hx-swap="innerHTML swap:0.25s"
                                           data-bs-toggle="modal" data-bs-target="#modalContainer">
                                            <i class="fa-solid fa-pen text-success"></i>
                                        </a>
                                        <a href="" hx-swap="none"
                                           hx-confirm="{% trans 'Are you sure you wish to delete the collection?' %}"
                                           hx-post="{% url 'psat:collection_delete' collection.id %}">
                                            <i class="fa-solid fa-square-xmark text-danger fs-5"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="list-group-item list-group-item-action">
                    추가된 컬렉션이 없습니다.
                </div>
            {% endif %}
            <div class="list-group-item list-group-item-action p-2"
                 hx-target="this" hx-swap="innerHTML swap:0.25s" hx-push-url="false">
                <a type="button" class="text-secondary" href=""
                   hx-get="{% url 'psat:collection_create' %}?problem_id={{ problem_id }}">
                    <i class="fa-solid fa-plus"></i> 새 컬렉션 만들기
                </a>
            </div>
        {% endpartialdef card_list %}
    </div>
{% endpartialdef reload_card_list %}

{% partialdef reload_card_item_title %}
    <div hx-swap-oob="innerHTML:#collectionTitle">
        {% partialdef card_item_title inline=True %}
            <h4 id="collectionTitle" class="fw-bold htmx-fade-out htmx-fade-in">
                {{ target_collection.title }}
            </h4>
        {% endpartialdef card_item_title %}
    </div>
{% endpartialdef reload_card_item_title %}

{% partialdef reload_item_contents %}
    <div hx-swap-oob="innerHTML:#collectionItemForm">
        {% partialdef item_contents inline=True %}
            {% if items %}
                <input type="hidden" name="collection" value="{{ items.0.collection_id }}"/>
                {% for item in items %}
                    <div class="d-flex fs-6 mb-2" hx-target="#main" hx-swap="innerHTML swap:0.25s" hx-push-url="true">
                        <input type="hidden" name="item" value="{{ item.id }}"/>
                        <div class="fw-bold me-2">{{ item.order }}.</div>
                        <div>
                            <div class="d-inline-block pe-1">
                                {% partial reference %}
                            </div>
                            <div class="d-inline-block">
                                {% partial question %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-nowrap fs-6 py-2">자료가 없습니다.</div>
            {% endif %}
        {% endpartialdef item_contents %}
    </div>
{% endpartialdef reload_item_contents %}

{% partialdef reload_card_item %} {# ItemView / SortItemView #}
    {% partial reload_card_item_title %}
    {% partial reload_item_contents %}
{% endpartialdef reload_card_item %}

{% partialdef reload_card %} {# ReloadView #}
    {% partial reload_card_list %}
    {% partial reload_card_item_title %}
    {% partial reload_item_contents %}
{% endpartialdef reload_card %}

{% partialdef reference %}
    <a class="text-decoration-none fw-bold"
       href="{% url 'psat:detail' item.problem_id %}"
       hx-get="{% url 'psat:detail' item.problem_id %}{{ url_options }}"
       hx-push-url="{% url 'psat:detail' item.problem_id %}">
        {{ item.year }}{{ item.ex|first }}{{ item.sub|first }}-{{ item.number|stringformat:'02d' }}
    </a>
    {% with image=item.problem.get_image_file %}
        {% if image.tag1 == 'Preparing Image' %}
            {{ icon_image.false|safe }}
        {% else %}
            <a class="text-decoration-none" hx-target="#modalContainer"
               href="" hx-push-url="false"
               hx-get="{% url 'psat:detail_image' item.problem_id %}"
               data-bs-toggle="modal" data-bs-target="#modalContainer">
                {{ icon_image.true|safe }}
            </a>
        {% endif %}
    {% endwith %}
{% endpartialdef reference %}

{% partialdef question %}
    {% with class='d-md-none' chars=30 %}
        {% partialdef link_snippet inline=True %}
            <a class="text-decoration-none {{ class }}"
               href="{% url 'psat:detail' item.problem_id %}"
               hx-get="{% url 'psat:detail' item.problem_id %}{{ url_options }}"
               hx-push-url="{% url 'psat:detail' item.problem_id %}">
                <h3 class="d-inline-block fs-6 small m-0">
                    {{ item.question|truncatechars:chars }}
                </h3>
            </a>
        {% endpartialdef link_snippet %}
    {% endwith %}
    {% with class='d-none d-md-inline d-lg-none' chars=40 %}{% partial link_snippet %}{% endwith %}
    {% with class='d-none d-lg-inline d-xl-none' chars=50 %}{% partial link_snippet %}{% endwith %}
    {% with class='d-none d-xl-inline' chars=60 %}{% partial link_snippet %}{% endwith %}
{% endpartialdef question %}

{% partialdef create_collection %}
    <form class="row" hx-post="{% url 'psat:collection_create' %}" hx-swap="none">
        <div class="input-group">
            <input type="text" class="form-control" id="id_title" name="title"
                   aria-label="Collection Title"
                   placeholder="컬렉션 이름을 입력하세요">
            <button class="btn btn-outline-secondary" type="submit">
                입력
            </button>
        </div>
    </form>
{% endpartialdef create_collection %}
