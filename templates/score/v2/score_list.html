{% extends 'list.html' %}
{% load static %}
{% load i18n %}
{% load psat_filter %}
{% load partials %}
{% load slippers %}

{% block main %}
    {% partialdef list_main inline=True %}
        {{ info|json_script:'info' }}
        <div class="pagetitle">
            <h1>{{ title }}
                <span class="fs-6 text-secondary">PSAT 기출문제 성적표</span>
            </h1>
            <nav>
                <ol class="breadcrumb" hx-target="#main" hx-swap="innerHTML swap:0.25s" hx-push-url="true">
                    <li class="breadcrumb-item">
                        <a href="{% url 'index' %}" hx-post="{% url 'index' %}">Home</a>
                    </li>
                    <li class="breadcrumb-item">Score</li>
                    <li class="breadcrumb-item active">PSAT</li>
                </ol>
            </nav>
        </div><!-- Page Title End -->

        <section class="section htmx-fade-in htmx-fade-out"
                 hx-target="#main" hx-swap="innerHTML swap:0.25s" hx-push-url="true">
        {% #content_row class3='p-4' %}
            {% #responsive_table %}
                <thead>{% partial thead %}</thead>
                <tbody>{% partial tbody %}</tbody>
            {% /responsive_table %}
            {% partial pagination %}
        {% /content_row %}
        </section>
    {% endpartialdef list_main %}
{% endblock main %}

{% partialdef thead %}
    <tr class="text-center table-warning">
        <th class="text-primary text-nowrap p-2 col-1">연도</th>
        <th class="text-primary text-nowrap p-2 col-1">시험</th>
        <th class="text-primary text-nowrap p-2 col-1">수험번호</th>
        <th class="text-primary text-nowrap p-2 col-1">직렬</th>
        <th class="text-primary text-nowrap p-2 col-1">성적표</th>
        <th class="text-primary text-nowrap p-2 col-1">
            {{ icon_subject.언어|safe }} 언어논리
        </th>
        <th class="text-primary text-nowrap p-2 col-1">
            {{ icon_subject.자료|safe }} 자료해석
        </th>
        <th class="text-primary text-nowrap p-2 col-1">
            {{ icon_subject.상황|safe }} 상황판단
        </th>
        <th class="text-primary text-nowrap p-2 col-1">
            {{ icon_subject.헌법|safe }} 헌법
        </th>
    </tr>
{% endpartialdef thead %}

{% partialdef tbody %}
    {% if page_obj %}
        {% for obj in page_obj %}
            <tr class="text-center">
                <td class="text-nowrap p-2">
                    <a href="" hx-swap="innerHTML swap:0.25s" class="fw-bold"
                       hx-get="{% url 'psat:base' %}?year={{ obj.year }}&ex={{ obj.ex }}"
                       hx-target="#main" hx-push-url="{% url 'psat:base' %}">
                        {{ obj.year }}년
                    </a>
                </td>
                <td class="text-nowrap p-2">
                    <a href="" hx-swap="innerHTML swap:0.25s" class="fw-bold"
                       hx-get="{% url 'psat:base' %}?year={{ obj.year }}&ex={{ obj.ex }}"
                       hx-target="#main" hx-push-url="{% url 'psat:base' %}">
                        {{ obj.exam }}
                    </a>
                </td>
                {% if obj.student %}
                    <td class="text-nowrap p-2">
                        {% if obj.student.serial %}
                            {{ obj.student.serial }} {% partial update_student %}
                        {% else %}
                            {% partial update_student %}
                        {% endif %}
                    </td>
                    <td class="text-nowrap p-2">
                        {{ obj.student.department.name }} {% partial update_student %}
                    </td>
                {% else %}
                    <td class="text-nowrap p-2">
                        {% partial create_student %}
                    </td>
                    <td class="text-nowrap p-2">
                        {% partial create_student %}
                    </td>
                {% endif %}
                <td class="text-nowrap p-2">
                    {% if obj.is_completed %}
                        <a class="badge rounded-pill text-bg-success"
                           href="{% url 'score:detail_year_ex' obj.year obj.ex %}"
                           hx-get="{% url 'score:detail_year_ex' obj.year obj.ex %}"
                           hx-push-url="true" hx-target="#main"
                           hx-swap="innerHTML swap:0.25s">
                            확인
                        </a>
                    {% endif %}
                </td>
                <td class="text-nowrap p-2">
                    {% with target=obj.eoneo %}{% partial process_badge %}{% endwith %}
                </td>
                <td class="text-nowrap p-2">
                    {% with target=obj.jaryo %}{% partial process_badge %}{% endwith %}
                </td>
                <td class="text-nowrap p-2">
                    {% with target=obj.sanghwang %}{% partial process_badge %}{% endwith %}
                </td>
                <td class="text-nowrap p-2">
                    {% if obj.heonbeob %}
                        {% with target=obj.heonbeob %}{% partial process_badge %}{% endwith %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    {% endif %}
{% endpartialdef tbody %}

{% partialdef update_student %}
    <a class="badge rounded-pill text-bg-warning"
       hx-get="{% url 'score:student_update_modal' obj.student.id %}" href=""
       hx-target="#modalContainer" hx-swap="innerHTML" hx-push-url="false"
       data-bs-toggle="modal" data-bs-target="#modalContainer">
        수정
    </a>
{% endpartialdef update_student %}

{% partialdef create_student %}
    <a class="badge rounded-pill text-bg-warning mx-2"
       hx-get="{% url 'score:student_create_modal' obj.year obj.ex %}" href=""
       hx-target="#modalContainer" hx-swap="innerHTML" hx-push-url="false"
       data-bs-toggle="modal" data-bs-target="#modalContainer">
        입력
    </a>
{% endpartialdef create_student %}

{% partialdef process_badge %}
    {% if target %}
        {% if target.status is None %}
            {% if obj.student %}
                <a class="badge rounded-pill text-bg-primary"
                   href="{% url 'score:detail_year_ex' target.year target.exam.abbr %}"
                   hx-get="{% url 'score:detail_year_ex' target.year target.exam.abbr %}">
                    작성 전
                </a>
            {% else %}
                <a class="badge rounded-pill text-bg-primary" href="" hx-push-url="false"
                   hx-get="{% url 'score:no_student_modal' %}" hx-target="#modalContainer"
                   data-bs-toggle="modal" data-bs-target="#modalContainer">
                    작성 전
                </a>
            {% endif %}
        {% elif target.status is False %}
            <a class="badge rounded-pill text-bg-warning"
               href="{% url 'score:detail_year_ex' target.year target.exam.abbr %}"
               hx-get="{% url 'score:detail_year_ex' target.year target.exam.abbr %}">
                작성 중
            </a>
        {% elif target.status is True %}
            <a class="badge rounded-pill text-bg-success"
               href="{% url 'score:detail_year_ex' target.year target.exam.abbr %}"
               hx-get="{% url 'score:detail_year_ex' target.year target.exam.abbr %}">
                제출 완료
            </a>
        {% elif target.status == 'N/A' %}
        {% endif %}
    {% endif %}
{% endpartialdef process_badge %}


{# ################ #}
{# Pagination start #}
{# ################ #}

{# Pagination partial #}
{% partialdef pagination_li %}
    <li {% if status == 'active' %}aria-current="page"{% endif %}
        class="page-item {{ status }}">
        <a class="page-link" href=""
           {% if status == 'disabled' %}tabindex="-1" aria-disabled="true"
           {% else %}hx-get="{{ pagination_url }}?page={{ page_num }}"{% endif %}>
            {% if chevron %}<i class="fa-solid fa-chevron-{{ chevron }}"></i>
            {% else %}{{ anchor_text }}{% endif %}
        </a>
    </li>
{% endpartialdef pagination_li %}

{# Pagination link partial #}
{% partialdef pagination %}
    {% #pagination_nav %}
        {% if page_obj.has_previous %}
            {% with page_num=page_obj.number|add:-1 chevron='left' %}
                {% partial pagination_li %}
            {% endwith %}
        {% endif %}
        {% for number in page_range %}
            {% with page_num=number anchor_text=number %}
                {% if number == page_obj.number %}
                    {% with status='active' %}{% partial pagination_li %}{% endwith %}
                {% elif number == page_obj.paginator.ELLIPSIS %}
                    {% with status='disabled' %}{% partial pagination_li %}{% endwith %}
                {% else %}
                    {% partial pagination_li %}
                {% endif %}
            {% endwith %}
        {% endfor %}
        {% if page_obj.has_next %}
            {% with page_num=page_obj.number|add:1 chevron='right' %}
                {% partial pagination_li %}
            {% endwith %}
        {% endif %}
    {% /pagination_nav %}
{% endpartialdef pagination %}
