{% load psat_filter %}
{% load partials %}
{% load slippers %}

<div class="card-header">
    예상 정답
    <a class="text-decoration-none ms-2" href="" hx-swap="none"
       hx-get="{% url 'predict_test:update_sheet_answer' %}">
        <span class="badge rounded-pill text-bg-warning">업데이트</span>
    </a>
</div>

<div class="card-body">
    <article class="table-responsive">
        <table class="table small align-middle">
            <thead>
                <tr class="text-center table-warning">
                   <th class="text-nowrap text-primary">번호</th>
                   <th class="text-nowrap text-primary">헌법</th>
                   <th class="text-nowrap text-primary">언어</th>
                   <th class="text-nowrap text-primary">자료</th>
                   <th class="text-nowrap text-primary">상황</th>
                </tr>
            </thead>
            <tbody>
                {% for i in 'x'|ljust:40 %}
                    <tr class="text-center">
                        <th>{{ forloop.counter }}번</th>
                        <td>aa</td>
                        <td>aa</td>
                        <td>aa</td>
                        <td>aa</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </article>

    {% for id in '0123' %}
        {% cycle '헌법' '언어' '자료' '상황' as sub silent %}
        {% cycle data_answer_correct.헌법 data_answer_correct.언어 data_answer_correct.자료 data_answer_correct.상황 as answer_correct silent %}
        {% cycle data_answer_predict.헌법 data_answer_predict.언어 data_answer_predict.자료 data_answer_predict.상황 as answer_predict silent %}
        {% cycle data_answer_student.헌법 data_answer_student.언어 data_answer_student.자료 data_answer_student.상황 as answer_student silent %}
        {% cycle info_answer_student.헌법 info_answer_student.언어 info_answer_student.자료 info_answer_student.상황 as info_answer silent %}
        {% partial answer_table %}
    {% endfor %}
</div>

{% partialdef answer_table %} {# answer_table partial #}
    <article class="table-responsive">
        <table class="table small align-middle">
            <tbody>
                {% if not info_answer.is_confirmed %}
                    <tr class="text-center">
                        <th>
                            <a class="btn btn-outline-danger my-4"
                               href="{% url 'predict_test:answer_input' info_answer.sub %}" hx-boost="true">
                                답안을 제출해주세요.
                            </a>
                        </th>
                    </tr>
                {% else %}
                    {% if ex == '칠급' or answer_student|length == 25  %}
                        {% for _ in '012' %}
                            {% cycle 10 10 5 as loop_counter silent %}
                            {% cycle 0 10 20 as loop_min silent %}
                            {% partial answer_table_tr %}
                        {% endfor %}
                    {% else %}
                        {% for _ in '0123' %}
                            {% cycle 10 10 10 10 as loop_counter silent %}
                            {% cycle 0 10 20 30 as loop_min silent %}
                            {% partial answer_table_tr %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </tbody>
        </table>
        {% if info_answer.is_confirmed %}
            <div>
                <span class="badge bg-success"><i class="fa-regular fa-circle-check"></i> 참고</span><br/>
                <ol class="text-success small fw-bold m-0">
                    {% if current_time < exam.end_datetime %}
                        <li>예상 정답 및 정확도는 시험이 종료된 이후에 확인 가능합니다.</li>
                    {% endif %}

                    {% if current_time < exam.answer_open_datetime %}
                        <li>정답 및 정답률은 공식적으로 정답이 공개된 이후에 확인 가능합니다.</li>
                    {% endif %}

                    {% if current_time > exam.answer_open_datetime %}
                        <li>정답률 = 정답을 선택한 응시생 수 / 답안 제출을 완료한 전체 응시생 수</li>
                    {% endif %}

                    <li>선택률 = 본인과 같은 정답을 선택한 응시생 수 / 답안 제출을 완료한 전체 응시생 수</li>

                    {% if current_time > exam.end_datetime and current_time < exam.answer_open_datetime %}
                        <li>정확도 = 예상 정답을 선택한 응시생 수 / 답안 제출을 완료한 전체 응시생 수</li>
                    {% endif %}
                </ol>
            </div>
        {% endif %}
    </article>
{% endpartialdef answer_table %}

{% partialdef answer_table_tr %}
    <tr class="text-center table-warning">
        <th class="text-nowrap" scope="row">문제 번호</th>
        {% for _ in 'x'|ljust:loop_counter %}
            <th>{{ forloop.counter|add:loop_min }}</th>
        {% endfor %}
    </tr>

    {# answer_predict #}
    {% if user.is_staff %}
        {% partialdef answer_predict_line inline=True %}
            <tr class="text-center">
                <th class="text-nowrap td-no-border" scope="row">예상 정답</th>
                {% for answer in answer_predict %}
                    {% if forloop.counter > loop_min and forloop.counter <= loop_min|add:loop_counter %}
                        <td class="td-no-border">
                            {% if answer.result == 'O' %}
                                <button data-number="{{ answer.number }}"
                                        class="btn btn-circle btn-sm fs-6 mx-1 my-2 btn-warning">
                                    <div id="{{ sub }}ans_{{ answer.number }}"
                                         class="htmx-fade-up-in delay-{{ forloop.counter|digit_of_one }}">
                                        {{ answer.ans_number }}
                                    </div>
                                </button>
                            {% else %}
                                <button data-number="{{ answer.number }}"
                                        class="btn btn-circle btn-sm fs-6 mx-1 my-2 btn-danger">
                                    <div id="{{ sub }}ans_{{ answer.number }}"
                                         class="htmx-fade-up-in delay-{{ forloop.counter|digit_of_one }}">
                                        {{ answer.ans_number }}
                                    </div>
                                </button>
                            {% endif %}
                        </td>
                    {% endif %}
                {% endfor %}
            </tr>
            <tr class="text-center">
                <th class="text-nowrap" scope="row">정확도(%)</th>
                {% for answer in answer_predict %}
                    {% if forloop.counter > loop_min and forloop.counter <= loop_min|add:loop_counter %}
                        <td>
                            {% if answer.result == 'O' %}
                                <div data-number="{{ answer.number }}" class="fw-bold text-warning">
                                    <div id="{{ sub }}accracy_{{ answer.number }}"
                                         class="htmx-fade-up-in delay-{{ forloop.counter|digit_of_one }}">
                                        {{ answer.rate_accuracy|floatformat:0 }}
                                    </div>
                                </div>
                            {% else %}
                                <div data-number="{{ answer.number }}" class="fw-bold text-danger">
                                    <div id="{{ sub }}accracy_{{ answer.number }}"
                                         class="htmx-fade-up-in delay-{{ forloop.counter|digit_of_one }}">
                                        {{ answer.rate_accuracy|floatformat:0 }}
                                    </div>
                                </div>
                            {% endif %}
                        </td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endpartialdef answer_predict_line %}
    {% else %}
        {% if current_time < exam.end_datetime %}
            <tr class="text-center">
                <th class="text-nowrap text-bg-warning td-no-border" scope="row">예상 정답</th>
                <td rowspan="2" colspan="{{ loop_counter }}" class="fw-bold text-bg-warning">
                    시험 종료전입니다.
                </td>
            </tr>
            <tr class="text-center">
                <th class="text-nowrap text-bg-warning" scope="row">정확도(%)</th>
            </tr>
        {% elif current_time < exam.answer_open_datetime %}
            {% partial answer_predict_line %}
        {% endif %}
    {% endif %}
{% endpartialdef answer_table_tr %}
